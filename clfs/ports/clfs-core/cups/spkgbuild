# description	: Print spooler and associated utilities
# homepage	: https://www.cups.org/
# maintainer	: Emmett1, emmett1.2miligrams at gmail.com
# depends	: gnutls libusb linux-pam
# makedepends	: dbus colord xdg-utils

name=cups
version=2.2.6
release=2
source=(https://github.com/apple/cups/releases/download/v$version/$name-$version-source.tar.gz
	cups.rc)

build() {
	cd $name-$version

	sed -i 's:444:644:' Makedefs.in
	sed -i '/MAN.EXT/s:.gz::' configure config-scripts/cups-manpages.m4
	
	aclocal  -I config-scripts
	autoconf -I config-scripts

	# fix lib to lib64
	sed -i.orig -e 's#$exec_prefix/lib/cups#$libdir/cups#g' configure
	
	CC=gcc \
	./configure --libdir=/usr/lib64            \
	            --disable-systemd            \
	            --with-rcdir=/tmp/cupsinit   \
	            --with-system-groups=lpadmin \
	            --with-docdir=/usr/share/$name/doc
	make
	make BUILDROOT=$PKG install

	# remove cups init script
	rm -fr $PKG/tmp

	mkdir -pv $PKG/usr/share/doc
	ln -svnf ../$name/doc $PKG/usr/share/doc/$name

	# Create a basic Cups client configuration file
	echo "ServerName /var/run/cups/cups.sock" > $PKG/etc/cups/client.conf

	# Linux PAM Configuration
	mkdir -p $PKG/etc/pam.d
	cat > $PKG/etc/pam.d/cups << "EOF"
# Begin /etc/pam.d/cups

auth    include system-auth
account include system-account
session include system-session

# End /etc/pam.d/cups
EOF

	rm -fr $PKG/var/run

	install -Dm755 $SRC/cups.rc $PKG/etc/rc.d/cups
}
